/**
 * 32x32 Pixel Art Character Generator for SnowClash
 * 귀여운 아이 캐릭터 - Red/Blue 팀 지원
 */

// 색상 팔레트
const PALETTE = {
  // 공통
  TRANSPARENT: null,
  WHITE: 0xFFFFFF,
  SKIN_LIGHT: 0xFFDBAC,
  SKIN_MEDIUM: 0xF0C090,
  BLACK: 0x000000,
  BROWN: 0x6D4C41,
  PINK: 0xFFB6C1,

  // Red 팀
  RED_MAIN: 0xE53935,
  RED_DARK: 0xB71C1C,
  RED_LIGHT: 0xFF6659,

  // Blue 팀
  BLUE_MAIN: 0x1E88E5,
  BLUE_DARK: 0x0D47A1,
  BLUE_LIGHT: 0x6AB7FF,

  // 스턴 상태
  STUN_OVERLAY: 0x666666,
};

// 픽셀 데이터 (32x32)
// 0: 투명, 1: 살색밝음, 2: 살색중간, 3: 검정, 4: 팀색상, 5: 팀색상어두움, 6: 팀색상밝음, 7: 흰색, 8: 갈색, 9: 핑크
const CHARACTER_IDLE = [
  '00000000000000444444000000000000',
  '00000000000044444444440000000000',
  '00000000004444444444444400000000',
  '00000000044455444445544440000000',
  '00000000444444444444444444000000',
  '00000004444444444444444444400000',
  '00000044444444444444444444440000',
  '00000044444444444444444444440000',
  '00000001111111111111111111100000',
  '00000011111111111111111111110000',
  '00000111111111111111111111111000',
  '00001111177777711177777711111100',
  '00001111177777711177777711111100',
  '00001111177733711177733711111100',
  '00001111177733711177733711111100',
  '00001111177777711177777711111100',
  '00001111111111111111111111111100',
  '00001111111111111111111111111100',
  '00009911111111111111111111199900',
  '00009911111111999911111111199900',
  '00001111111119999991111111111100',
  '00001111111111111111111111111100',
  '00000111111111111111111111111000',
  '00000011111111111111111111110000',
  '00000000444444444444444440000000',
  '00000004444444444444444444000000',
  '00000044444455444445544444400000',
  '00000004444444444444444444000000',
  '00000000444444004444444000000000',
  '00000000444444004444444000000000',
  '00000000888888008888880000000000',
  '00000000888888008888880000000000',
];

const CHARACTER_WALK1 = [
  '00000000000000444444000000000000',
  '00000000000044444444440000000000',
  '00000000004444444444444400000000',
  '00000000044455444445544440000000',
  '00000000444444444444444444000000',
  '00000004444444444444444444400000',
  '00000044444444444444444444440000',
  '00000044444444444444444444440000',
  '00000001111111111111111111100000',
  '00000011111111111111111111110000',
  '00000111111111111111111111111000',
  '00001111177777711177777711111100',
  '00001111177777711177777711111100',
  '00001111177733711177733711111100',
  '00001111177733711177733711111100',
  '00001111177777711177777711111100',
  '00001111111111111111111111111100',
  '00001111111111111111111111111100',
  '00009911111111111111111111199900',
  '00009911111111999911111111199900',
  '00001111111119999991111111111100',
  '00001111111111111111111111111100',
  '00000111111111111111111111111000',
  '00000011111111111111111111110000',
  '00000000444444444444444440000000',
  '00000004444444444444444444000000',
  '00000044444455444445544444400000',
  '00000004444444444444444444000000',
  '00000000044444004444440000000000',
  '00000000888888004444444000000000',
  '00000000888888008888880000000000',
  '00000000000000008888880000000000',
];

const CHARACTER_WALK2 = [
  '00000000000000444444000000000000',
  '00000000000044444444440000000000',
  '00000000004444444444444400000000',
  '00000000044455444445544440000000',
  '00000000444444444444444444000000',
  '00000004444444444444444444400000',
  '00000044444444444444444444440000',
  '00000044444444444444444444440000',
  '00000001111111111111111111100000',
  '00000011111111111111111111110000',
  '00000111111111111111111111111000',
  '00001111177777711177777711111100',
  '00001111177777711177777711111100',
  '00001111177733711177733711111100',
  '00001111177733711177733711111100',
  '00001111177777711177777711111100',
  '00001111111111111111111111111100',
  '00001111111111111111111111111100',
  '00009911111111111111111111199900',
  '00009911111111999911111111199900',
  '00001111111119999991111111111100',
  '00001111111111111111111111111100',
  '00000111111111111111111111111000',
  '00000011111111111111111111110000',
  '00000000444444444444444440000000',
  '00000004444444444444444444000000',
  '00000044444455444445544444400000',
  '00000004444444444444444444000000',
  '00000000444444004444440000000000',
  '00000000444444008888880000000000',
  '00000000888888008888880000000000',
  '00000000888888000000000000000000',
];

const CHARACTER_WALK3 = [
  '00000000000000444444000000000000',
  '00000000000044444444440000000000',
  '00000000004444444444444400000000',
  '00000000044455444445544440000000',
  '00000000444444444444444444000000',
  '00000004444444444444444444400000',
  '00000044444444444444444444440000',
  '00000044444444444444444444440000',
  '00000001111111111111111111100000',
  '00000011111111111111111111110000',
  '00000111111111111111111111111000',
  '00001111177777711177777711111100',
  '00001111177777711177777711111100',
  '00001111177733711177733711111100',
  '00001111177733711177733711111100',
  '00001111177777711177777711111100',
  '00001111111111111111111111111100',
  '00001111111111111111111111111100',
  '00009911111111111111111111199900',
  '00009911111111999911111111199900',
  '00001111111119999991111111111100',
  '00001111111111111111111111111100',
  '00000111111111111111111111111000',
  '00000011111111111111111111110000',
  '00000000444444444444444440000000',
  '00000004444444444444444444000000',
  '00000044444455444445544444400000',
  '00000004444444444444444444000000',
  '00000000444440044444444000000000',
  '00000000444440004444444000000000',
  '00000000888880008888880000000000',
  '00000000888880008888880000000000',
];

const CHARACTER_WALK4 = [
  '00000000000000444444000000000000',
  '00000000000044444444440000000000',
  '00000000004444444444444400000000',
  '00000000044455444445544440000000',
  '00000000444444444444444444000000',
  '00000004444444444444444444400000',
  '00000044444444444444444444440000',
  '00000044444444444444444444440000',
  '00000001111111111111111111100000',
  '00000011111111111111111111110000',
  '00000111111111111111111111111000',
  '00001111177777711177777711111100',
  '00001111177777711177777711111100',
  '00001111177733711177733711111100',
  '00001111177733711177733711111100',
  '00001111177777711177777711111100',
  '00001111111111111111111111111100',
  '00001111111111111111111111111100',
  '00009911111111111111111111199900',
  '00009911111111999911111111199900',
  '00001111111119999991111111111100',
  '00001111111111111111111111111100',
  '00000111111111111111111111111000',
  '00000011111111111111111111110000',
  '00000000444444444444444440000000',
  '00000004444444444444444444000000',
  '00000044444455444445544444400000',
  '00000004444444444444444444000000',
  '00000000444444404444440000000000',
  '00000000444444408888880000000000',
  '00000000888888008888880000000000',
  '00000000888888000000000000000000',
];

const CHARACTER_THROW_PREPARE = [
  '00000000000000444444000000000000',
  '00000000000044444444440000000000',
  '00000000004444444444444400000000',
  '00000000044455444445544440000000',
  '00000000444444444444444444000000',
  '00000004444444444444444444400000',
  '00000044444444444444444444440000',
  '00000044444444444444444444440000',
  '00000001111111111111111111100000',
  '00000011111111111111111111110000',
  '00000111111111111111111111111000',
  '00001111177777711177777711111100',
  '00001111177777711177777711111100',
  '00001111177733711177733711111100',
  '00001111177733711177733711111100',
  '00001111177777711177777711111100',
  '00001111111111111111111111111100',
  '00001111111111111111111111111100',
  '00009911111111111111111111199900',
  '00009911111111999911111111199900',
  '00001111111119999991111111111100',
  '00001111111111111111111111111100',
  '00000111111111111111111111111000',
  '00000011111111111111111111110011',
  '00000000444444444444444440001111',
  '00000004444444444444444444001111',
  '00000044444455444445544444401111',
  '00000004444444444444444444400111',
  '00000000444444004444444000000000',
  '00000000444444004444444000000000',
  '00000000888888008888880000000000',
  '00000000888888008888880000000000',
];

const CHARACTER_THROW = [
  '00000000000000444444000000000000',
  '00000000000044444444440000000000',
  '00000000004444444444444400000000',
  '00000000044455444445544440000000',
  '00000000444444444444444444000000',
  '00000004444444444444444444400000',
  '00000044444444444444444444440000',
  '00000044444444444444444444440000',
  '00000001111111111111111111100000',
  '00000011111111111111111111110000',
  '00000111111111111111111111111000',
  '00001111111111111111111111111100',
  '00001111133333311133333311111100',
  '00001111133333311133333311111100',
  '00001111133333311133333311111100',
  '00001111111111111111111111111100',
  '00001111111111111111111111111100',
  '00001111111111111111111111111100',
  '00009911111111111111111111199900',
  '00119911111111999911111111199900',
  '00111111111119999991111111111100',
  '00111111111111111111111111111000',
  '00111100444444444444444440000000',
  '00000004444444444444444444000000',
  '00000044444455444445544444400000',
  '00000004444444444444444444000000',
  '00000000444444004444444000000000',
  '00000000444444004444444000000000',
  '00000000888888008888880000000000',
  '00000000888888008888880000000000',
  '00000000888888008888880000000000',
  '00000000888888008888880000000000',
];

const CHARACTER_THROW_FOLLOW = [
  '00000000000000444444000000000000',
  '00000000000044444444440000000000',
  '00000000004444444444444400000000',
  '00000000044455444445544440000000',
  '00000000444444444444444444000000',
  '00000004444444444444444444400000',
  '00000044444444444444444444440000',
  '00000044444444444444444444440000',
  '00000001111111111111111111100000',
  '00000011111111111111111111110000',
  '00000111111111111111111111111000',
  '00001111177777711177777711111100',
  '00001111177777711177777711111100',
  '00001111177733711177733711111100',
  '00001111177733711177733711111100',
  '00001111177777711177777711111100',
  '00001111111111111111111111111100',
  '00001111111111111111111111111100',
  '00009911111111111111111111199900',
  '00009911111111999911111111199900',
  '11111111111119999991111111111100',
  '11111111111111111111111111111000',
  '11111000444444444444444440000000',
  '00000004444444444444444444000000',
  '00000044444455444445544444400000',
  '00000004444444444444444444000000',
  '00000000444444004444444000000000',
  '00000000444444004444444000000000',
  '00000000888888008888880000000000',
  '00000000888888008888880000000000',
  '00000000888888008888880000000000',
  '00000000888888008888880000000000',
];

const CHARACTER_STUNNED = [
  '00000000000000444444000000000000',
  '00000000000044444444440000000000',
  '00000000004444444444444400000000',
  '00000000044455444445544440000000',
  '00000000444444444444444444000000',
  '00000004444444444444444444400000',
  '00000044444444444444444444440000',
  '00000044444444444444444444440000',
  '00000001111111111111111111100000',
  '00000011111111111111111111110000',
  '00000111111111111111111111111000',
  '00001111130000311130000311111100',
  '00001111103003011103003011111100',
  '00001111100330011100330011111100',
  '00001111103003011103003011111100',
  '00001111130000311130000311111100',
  '00001111111111111111111111111100',
  '00001111111111111111111111111100',
  '00009911111111111111111111199900',
  '00009911111119000091111111199900',
  '00001111111119000091111111111100',
  '00001111111111111111111111111100',
  '00000111111111111111111111111000',
  '00000011111111111111111111110000',
  '00000000444444444444444440000000',
  '00000004444444444444444444000000',
  '00000044444455444445544444400000',
  '00000004444444444444444444000000',
  '00000000444444004444444000000000',
  '00000000444444004444444000000000',
  '00000000888888008888880000000000',
  '00000000888888008888880000000000',
];

export type CharacterState = 'idle' | 'walk1' | 'walk2' | 'walk3' | 'walk4' | 'throw_prepare' | 'throw' | 'throw_follow' | 'stunned';
export type TeamColor = 'red' | 'blue';

const FRAMES: Record<CharacterState, string[]> = {
  idle: CHARACTER_IDLE,
  walk1: CHARACTER_WALK1,
  walk2: CHARACTER_WALK2,
  walk3: CHARACTER_WALK3,
  walk4: CHARACTER_WALK4,
  throw_prepare: CHARACTER_THROW_PREPARE,
  throw: CHARACTER_THROW,
  throw_follow: CHARACTER_THROW_FOLLOW,
  stunned: CHARACTER_STUNNED,
};

/**
 * Phaser Scene에서 픽셀 캐릭터 텍스처 생성
 */
export function generateCharacterTextures(scene: Phaser.Scene): void {
  const teams: TeamColor[] = ['red', 'blue'];
  const states: CharacterState[] = ['idle', 'walk1', 'walk2', 'walk3', 'walk4', 'throw_prepare', 'throw', 'throw_follow', 'stunned'];

  teams.forEach(team => {
    states.forEach(state => {
      const key = `character_${team}_${state}`;
      if (scene.textures.exists(key)) return;

      const graphics = scene.make.graphics({ x: 0, y: 0 });
      drawCharacter(graphics, FRAMES[state], team, state === 'stunned');
      graphics.generateTexture(key, 32, 32);
      graphics.destroy();
    });
  });

  // 눈덩이 텍스처도 생성
  generateSnowballTextures(scene);
}

function drawCharacter(
  graphics: Phaser.GameObjects.Graphics,
  pixelData: string[],
  team: TeamColor,
  isStunned: boolean
): void {
  const teamColors = team === 'red'
    ? { main: PALETTE.RED_MAIN, dark: PALETTE.RED_DARK, light: PALETTE.RED_LIGHT }
    : { main: PALETTE.BLUE_MAIN, dark: PALETTE.BLUE_DARK, light: PALETTE.BLUE_LIGHT };

  for (let y = 0; y < 32; y++) {
    const row = pixelData[y];
    for (let x = 0; x < 32; x++) {
      const pixel = row[x];
      let color: number | null = null;

      switch (pixel) {
        case '0': color = null; break; // 투명
        case '1': color = PALETTE.SKIN_LIGHT; break; // 살색 밝음
        case '2': color = PALETTE.SKIN_MEDIUM; break; // 살색 중간
        case '3': color = PALETTE.BLACK; break; // 검정 (눈, 입)
        case '4': color = teamColors.main; break; // 팀 메인 색상
        case '5': color = teamColors.dark; break; // 팀 어두운 색상
        case '6': color = teamColors.light; break; // 팀 밝은 색상
        case '7': color = PALETTE.WHITE; break; // 흰색 (하이라이트)
        case '8': color = PALETTE.BROWN; break; // 갈색 (신발)
        case '9': color = PALETTE.PINK; break; // 핑크 (볼)
      }

      if (color !== null) {
        if (isStunned) {
          // 스턴 상태: 회색조로 변환
          color = blendWithGray(color, 0.5);
        }
        graphics.fillStyle(color, 1);
        graphics.fillRect(x, y, 1, 1);
      }
    }
  }
}

function blendWithGray(color: number, amount: number): number {
  const r = (color >> 16) & 0xFF;
  const g = (color >> 8) & 0xFF;
  const b = color & 0xFF;

  const gray = Math.round((r + g + b) / 3);

  const newR = Math.round(r + (gray - r) * amount);
  const newG = Math.round(g + (gray - g) * amount);
  const newB = Math.round(b + (gray - b) * amount);

  return (newR << 16) | (newG << 8) | newB;
}

/**
 * 눈덩이 픽셀아트 텍스처 생성
 */
function generateSnowballTextures(scene: Phaser.Scene): void {
  // 일반 눈덩이 (10x10)
  const normalKey = 'snowball_normal';
  if (!scene.textures.exists(normalKey)) {
    const g = scene.make.graphics({ x: 0, y: 0 });
    drawSnowball(g, 10, false);
    g.generateTexture(normalKey, 10, 10);
    g.destroy();
  }

  // 차징 눈덩이 (18x18)
  const chargedKey = 'snowball_charged';
  if (!scene.textures.exists(chargedKey)) {
    const g = scene.make.graphics({ x: 0, y: 0 });
    drawSnowball(g, 18, true);
    g.generateTexture(chargedKey, 18, 18);
    g.destroy();
  }

  // 팀 색상 눈덩이
  ['red', 'blue'].forEach(team => {
    const color = team === 'red' ? PALETTE.RED_LIGHT : PALETTE.BLUE_LIGHT;

    const normalTeamKey = `snowball_${team}_normal`;
    if (!scene.textures.exists(normalTeamKey)) {
      const g = scene.make.graphics({ x: 0, y: 0 });
      drawColoredSnowball(g, 10, color);
      g.generateTexture(normalTeamKey, 10, 10);
      g.destroy();
    }

    const chargedTeamKey = `snowball_${team}_charged`;
    if (!scene.textures.exists(chargedTeamKey)) {
      const g = scene.make.graphics({ x: 0, y: 0 });
      drawColoredSnowball(g, 18, color);
      g.generateTexture(chargedTeamKey, 18, 18);
      g.destroy();
    }
  });
}

function drawSnowball(graphics: Phaser.GameObjects.Graphics, size: number, charged: boolean): void {
  const center = size / 2;
  const radius = size / 2 - 1;

  // 그림자
  graphics.fillStyle(0xCCCCCC, 0.5);
  graphics.fillCircle(center + 1, center + 1, radius);

  // 메인 눈덩이
  graphics.fillStyle(0xFFFFFF, 1);
  graphics.fillCircle(center, center, radius);

  // 하이라이트
  graphics.fillStyle(0xFFFFFF, 1);
  graphics.fillCircle(center - radius / 3, center - radius / 3, radius / 4);

  if (charged) {
    // 차징 눈덩이는 테두리 추가
    graphics.lineStyle(2, 0xADD8E6, 1);
    graphics.strokeCircle(center, center, radius);
  }
}

function drawColoredSnowball(graphics: Phaser.GameObjects.Graphics, size: number, color: number): void {
  const center = size / 2;
  const radius = size / 2 - 1;

  // 그림자
  graphics.fillStyle(0x888888, 0.3);
  graphics.fillCircle(center + 1, center + 1, radius);

  // 메인 눈덩이 (팀 색상)
  graphics.fillStyle(color, 0.9);
  graphics.fillCircle(center, center, radius);

  // 흰색 코어
  graphics.fillStyle(0xFFFFFF, 0.7);
  graphics.fillCircle(center, center, radius * 0.6);

  // 하이라이트
  graphics.fillStyle(0xFFFFFF, 1);
  graphics.fillCircle(center - radius / 3, center - radius / 3, radius / 4);
}

/**
 * 캐릭터 애니메이션 생성
 */
export function createCharacterAnimations(scene: Phaser.Scene): void {
  const teams: TeamColor[] = ['red', 'blue'];

  teams.forEach(team => {
    // 걷기 애니메이션 (4프레임)
    const walkKey = `${team}_walk`;
    if (!scene.anims.exists(walkKey)) {
      scene.anims.create({
        key: walkKey,
        frames: [
          { key: `character_${team}_walk1` },
          { key: `character_${team}_walk3` },
          { key: `character_${team}_walk2` },
          { key: `character_${team}_walk4` },
        ],
        frameRate: 8,
        repeat: -1
      });
    }

    // 대기 애니메이션
    const idleKey = `${team}_idle`;
    if (!scene.anims.exists(idleKey)) {
      scene.anims.create({
        key: idleKey,
        frames: [{ key: `character_${team}_idle` }],
        frameRate: 1,
        repeat: -1
      });
    }

    // 던지기 애니메이션 (3단계)
    const throwKey = `${team}_throw`;
    if (!scene.anims.exists(throwKey)) {
      scene.anims.create({
        key: throwKey,
        frames: [
          { key: `character_${team}_throw_prepare` },
          { key: `character_${team}_throw` },
          { key: `character_${team}_throw_follow` },
          { key: `character_${team}_idle` },
        ],
        frameRate: 10,
        repeat: 0
      });
    }

    // 스턴 애니메이션
    const stunnedKey = `${team}_stunned`;
    if (!scene.anims.exists(stunnedKey)) {
      scene.anims.create({
        key: stunnedKey,
        frames: [{ key: `character_${team}_stunned` }],
        frameRate: 1,
        repeat: -1
      });
    }
  });
}
